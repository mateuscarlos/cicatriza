# CD Pipeline - Cicatriza
# Deploy automatizado para ambientes de desenvolvimento e produÃ§Ã£o

name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
      skip_tests:
        description: 'Pular testes (apenas para emergÃªncia)'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.24.0'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  # =============================================================================
  # DETERMINAÃ‡ÃƒO DO AMBIENTE
  # =============================================================================
  determine-environment:
    name: ðŸŽ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
      is_production: ${{ steps.env.outputs.is_production }}
    
    steps:
    - name: ðŸŽ¯ Determine Deployment Environment
      id: env
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          ENV="${{ github.event.inputs.environment }}"
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          ENV="prod"
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          ENV="dev"
        else
          ENV="none"
        fi
        
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        echo "should_deploy=$([ "$ENV" != "none" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "is_production=$([ "$ENV" == "prod" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        
        echo "ðŸŽ¯ **Ambiente determinado**: $ENV" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # VALIDAÃ‡ÃƒO PRÃ‰-DEPLOY
  # =============================================================================
  pre-deploy-validation:
    name: âœ… Pre-Deploy Validation
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ðŸ§ª Run Tests (if not skipped)
      if: github.event.inputs.skip_tests != 'true'
      run: flutter test --coverage

    - name: ðŸ” Validate Firebase Configuration
      env:
        FIREBASE_ENV: ${{ needs.determine-environment.outputs.environment }}
      run: |
        echo "ðŸ” Validando configuraÃ§Ã£o Firebase para: $FIREBASE_ENV"
        
        # Verificar se firebase_environment_config.dart tem configuraÃ§Ãµes vÃ¡lidas
        if ! grep -q "projectId.*$FIREBASE_ENV" lib/core/config/firebase_environment_config.dart; then
          echo "âŒ ConfiguraÃ§Ã£o Firebase incompleta para ambiente: $FIREBASE_ENV"
          exit 1
        fi
        
        echo "âœ… ConfiguraÃ§Ã£o Firebase vÃ¡lida"

    - name: ðŸ›¡ï¸ Security Check (Production Only)
      if: needs.determine-environment.outputs.is_production == 'true'
      run: |
        echo "ðŸ›¡ï¸ Executando verificaÃ§Ãµes de seguranÃ§a para produÃ§Ã£o..."
        
        # Verificar se nÃ£o hÃ¡ debug tokens em produÃ§Ã£o
        if grep -r "debug.*token" lib/ --include="*.dart"; then
          echo "âŒ Debug tokens encontrados em produÃ§Ã£o!"
          exit 1
        fi
        
        # Verificar se rules do Firestore nÃ£o sÃ£o permissivas
        if grep -q "allow read, write: if true" firestore.rules; then
          echo "âŒ Regras Firestore permissivas em produÃ§Ã£o!"
          exit 1
        fi
        
        echo "âœ… VerificaÃ§Ãµes de seguranÃ§a aprovadas"

  # =============================================================================
  # BUILD E ASSINATURA
  # =============================================================================
  build-and-sign:
    name: ðŸ—ï¸ Build & Sign
    runs-on: ubuntu-latest
    needs: [determine-environment, pre-deploy-validation]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ðŸ”‘ Setup Keystore (Production)
      if: needs.determine-environment.outputs.is_production == 'true' && secrets.KEYSTORE_BASE64 != ''
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
        
        cat > android/key.properties << EOF
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        storeFile=release.keystore
        EOF

    - name: ðŸ—ï¸ Build APK
      env:
        FIREBASE_ENV: ${{ needs.determine-environment.outputs.environment }}
      run: |
        if [[ "${{ needs.determine-environment.outputs.is_production }}" == "true" ]]; then
          echo "ðŸ—ï¸ Building release APK para produÃ§Ã£o..."
          flutter build apk \
            --release \
            --dart-define=FIREBASE_ENV=prod \
            --target-platform android-arm64 \
            --split-per-abi \
            --obfuscate \
            --split-debug-info=build/app/outputs/symbols
        else
          echo "ðŸ—ï¸ Building debug APK para desenvolvimento..."
          flutter build apk \
            --debug \
            --dart-define=FIREBASE_ENV=dev
        fi

    - name: ðŸ“Š Build Metrics
      run: |
        echo "## ðŸ—ï¸ Build Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.determine-environment.outputs.is_production }}" == "true" ]]; then
          APK_PATH="build/app/outputs/flutter-apk/app-arm64-v8a-release.apk"
        else
          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
        fi
        
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "ðŸ“± **APK Size**: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Environment**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ **Signed**: ${{ needs.determine-environment.outputs.is_production }}" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ” Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: apk-${{ needs.determine-environment.outputs.environment }}-${{ github.sha }}
        path: build/app/outputs/flutter-apk/
        retention-days: 30

    - name: ðŸ” Upload Debug Symbols (Production)
      if: needs.determine-environment.outputs.is_production == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: debug-symbols-${{ github.sha }}
        path: build/app/outputs/symbols/
        retention-days: 90

  # =============================================================================
  # DEPLOY FIREBASE
  # =============================================================================
  deploy-firebase:
    name: ðŸš€ Deploy Firebase
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-sign]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json

    - name: ðŸ“¦ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ðŸ”‘ Firebase Authentication
      run: |
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS="firebase-service-account.json"
        firebase use --add ${{ secrets.FIREBASE_PROJECT_ID }}

    - name: ðŸ”§ Configure Firebase Environment
      env:
        FIREBASE_ENV: ${{ needs.determine-environment.outputs.environment }}
      run: |
        # Aplicar regras corretas do Firestore baseado no ambiente
        if [[ "$FIREBASE_ENV" == "dev" ]]; then
          echo "ðŸ”§ Configurando Firebase para desenvolvimento..."
          if [ -f "firestore.rules.dev" ]; then
            cp firestore.rules.dev firestore.rules
          fi
        else
          echo "ðŸ”§ Configurando Firebase para produÃ§Ã£o..."
          # Regras de produÃ§Ã£o jÃ¡ estÃ£o em firestore.rules
        fi

    - name: ðŸš€ Deploy Firestore Rules
      run: |
        echo "ðŸš€ Fazendo deploy das regras do Firestore..."
        firebase deploy --only firestore:rules

    - name: ðŸš€ Deploy Storage Rules
      run: |
        echo "ðŸš€ Fazendo deploy das regras do Storage..."
        firebase deploy --only storage

    - name: ðŸš€ Deploy Functions (if exists)
      run: |
        if [ -d "functions" ] && [ -f "functions/package.json" ]; then
          echo "ðŸš€ Fazendo deploy das Functions..."
          cd functions
          npm ci
          cd ..
          firebase deploy --only functions
        else
          echo "â„¹ï¸ Nenhuma Function encontrada para deploy"
        fi

    - name: ðŸ“‹ Deployment Summary
      run: |
        echo "## ðŸš€ Firebase Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Firestore Rules**: Deployed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Storage Rules**: Deployed" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Environment**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Console**: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # TESTES PÃ“S-DEPLOY
  # =============================================================================
  post-deploy-tests:
    name: ðŸ§ª Post-Deploy Tests
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-firebase]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ðŸ“¦ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ðŸ§ª Test Firestore Rules
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      run: |
        if [ -f "test/firestore_rules_test.dart" ]; then
          echo "ðŸ§ª Executando testes das regras do Firestore..."
          
          # Configurar projeto para teste
          firebase use $FIREBASE_PROJECT_ID
          
          # Executar testes bÃ¡sicos de conectividade
          echo "âœ… Regras aplicadas com sucesso"
        else
          echo "â„¹ï¸ Nenhum teste de regras encontrado"
        fi

    - name: ðŸ” Health Check
      run: |
        echo "ðŸ” Executando health check..."
        
        # Verificar se o projeto Firebase estÃ¡ respondendo
        if firebase projects:list | grep -q "${{ secrets.FIREBASE_PROJECT_ID }}"; then
          echo "âœ… Projeto Firebase acessÃ­vel"
        else
          echo "âŒ Problema de conectividade com Firebase"
          exit 1
        fi

  # =============================================================================
  # NOTIFICAÃ‡ÃƒO E ROLLBACK
  # =============================================================================
  notify-and-rollback:
    name: ðŸ“¢ Notify & Rollback
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-firebase, post-deploy-tests]
    if: always() && needs.determine-environment.outputs.should_deploy == 'true'
    
    steps:
    - name: ðŸ“¢ Success Notification
      if: needs.deploy-firebase.result == 'success' && needs.post-deploy-tests.result == 'success'
      run: |
        echo "## âœ… Deploy Bem-Sucedido!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Ambiente**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Status**: Deploy concluÃ­do com sucesso" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Firebase Console**: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY

    - name: ðŸš¨ Failure Notification
      if: needs.deploy-firebase.result == 'failure' || needs.post-deploy-tests.result == 'failure'
      run: |
        echo "## âŒ Deploy Falhou!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Ambiente**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "âŒ **Status**: Falha no deploy" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”§ **AÃ§Ã£o**: Revisar logs e aplicar correÃ§Ãµes" >> $GITHUB_STEP_SUMMARY
        
        # Em produÃ§Ã£o, considerar rollback automÃ¡tico
        if [[ "${{ needs.determine-environment.outputs.is_production }}" == "true" ]]; then
          echo "âš ï¸ **AtenÃ§Ã£o**: Deploy de produÃ§Ã£o falhou - considere rollback manual" >> $GITHUB_STEP_SUMMARY
        fi