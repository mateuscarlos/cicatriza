# CI Pipeline - Cicatriza
# Executa testes, anÃ¡lise de cÃ³digo e validaÃ§Ãµes em todos os PRs e commits

name: CI Pipeline

on:
  push:
    branches: [ main, develop, validacao_m0_m1 ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # =============================================================================
  # ANÃLISE ESTÃTICA E LINTING
  # =============================================================================
  code-analysis:
    name: ðŸ” Code Analysis & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ðŸ§¹ Verify Formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: ðŸ” Analyze Code
      run: flutter analyze --fatal-infos --fatal-warnings

    - name: ðŸ“ Check Pub Spec
      run: dart pub deps --no-dev

    - name: ðŸ“‹ Generate Analysis Report
      if: always()
      run: |
        echo "## ðŸ“Š AnÃ¡lise de CÃ³digo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Flutter Analyze" >> $GITHUB_STEP_SUMMARY
        flutter analyze --fatal-infos --fatal-warnings > analysis.txt 2>&1 || true
        if [ -s analysis.txt ]; then
          echo "```" >> $GITHUB_STEP_SUMMARY
          cat analysis.txt >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Nenhum problema encontrado" >> $GITHUB_STEP_SUMMARY
        fi

  # =============================================================================
  # TESTES UNITÃRIOS
  # =============================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-analysis
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ðŸ§ª Run Unit Tests
      run: |
        flutter test \
          --coverage \
          --test-randomize-ordering-seed=random \
          --reporter=expanded

    - name: ðŸ“Š Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: coverage/lcov.info
        flags: unittests
        name: unit-tests-coverage
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false

    - name: ðŸ“‹ Generate Test Report
      if: always()
      run: |
        echo "## ðŸ§ª RelatÃ³rio de Testes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f coverage/lcov.info ]; then
          # Calcular cobertura
          COVERAGE=$(python3 scripts/calculate_coverage.py coverage/lcov.info 2>/dev/null || echo "N/A")
          echo "### ðŸ“Š Cobertura: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        echo "âœ… Testes unitÃ¡rios executados com sucesso" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # VALIDAÃ‡ÃƒO DE SEGURANÃ‡A FIREBASE
  # =============================================================================
  firebase-security:
    name: ðŸ” Firebase Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-analysis
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json

    - name: ðŸ“¦ Install Firebase CLI
      run: npm install -g firebase-tools

    - name: ðŸ” Validate Firestore Rules Syntax
      run: |
        echo "ðŸ” Validando sintaxe das regras do Firestore..."
        
        # Criar projeto temporÃ¡rio para validaÃ§Ã£o
        echo '{"projects":{"default":"demo-test"}}' > .firebaserc
        
        # Validar regras principais
        if ! firebase firestore:rules --help > /dev/null 2>&1; then
          echo "âŒ Firebase CLI nÃ£o instalado corretamente"
          exit 1
        fi
        
        echo "âœ… Sintaxe das regras Firestore vÃ¡lida"

    - name: ðŸ›¡ï¸ Security Rules Analysis
      run: |
        echo "## ðŸ” AnÃ¡lise de SeguranÃ§a Firebase" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Verificar se nÃ£o hÃ¡ regras permissivas
        if grep -q "allow read, write: if true" firestore.rules; then
          echo "âŒ **CRÃTICO**: Regras permissivas encontradas!" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          grep -n "allow read, write: if true" firestore.rules >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… Regras restritivas - SeguranÃ§a OK" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Verificar autenticaÃ§Ã£o obrigatÃ³ria
        if grep -q "isAuthenticated()" firestore.rules; then
          echo "âœ… AutenticaÃ§Ã£o obrigatÃ³ria implementada" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Verificar implementaÃ§Ã£o de autenticaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        fi

  # =============================================================================
  # BUILD DE VALIDAÃ‡ÃƒO
  # =============================================================================
  build-validation:
    name: ðŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [unit-tests, firebase-security]
    strategy:
      matrix:
        environment: [dev, prod]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies  
      run: flutter pub get

    - name: ðŸ—ï¸ Build APK (${{ matrix.environment }})
      run: |
        echo "ðŸ—ï¸ Building para ambiente: ${{ matrix.environment }}"
        flutter build apk \
          --dart-define=FIREBASE_ENV=${{ matrix.environment }} \
          --target-platform android-arm64 \
          --split-per-abi \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols

    - name: ðŸ“‹ Build Summary
      run: |
        echo "## ðŸ—ï¸ Build Summary - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-arm64-v8a-release.apk | cut -f1)
        echo "ðŸ“± **APK Size**: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Environment**: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status**: Build successful" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ” Archive Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: apk-${{ matrix.environment }}
        path: build/app/outputs/flutter-apk/
        retention-days: 7

  # =============================================================================
  # TESTES DE INTEGRAÃ‡ÃƒO (OPCIONAL)
  # =============================================================================
  integration-tests:
    name: ðŸ”„ Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-validation
    if: github.event_name == 'pull_request' && contains(github.head_ref, 'feature/')
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ðŸ”„ Run Integration Tests
      run: |
        if [ -d "integration_test" ] && [ "$(ls -A integration_test)" ]; then
          echo "ðŸ”„ Executando testes de integraÃ§Ã£o..."
          flutter test integration_test/
        else
          echo "â„¹ï¸ Nenhum teste de integraÃ§Ã£o encontrado"
        fi

  # =============================================================================
  # RESUMO FINAL
  # =============================================================================
  ci-summary:
    name: ðŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [code-analysis, unit-tests, firebase-security, build-validation]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate Final Summary
      run: |
        echo "# ðŸŽ¯ Pipeline CI - Resumo Final" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Status dos Jobs:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” **Code Analysis**: ${{ needs.code-analysis.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- ðŸ§ª **Unit Tests**: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” **Firebase Security**: ${{ needs.firebase-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ **Build Validation**: ${{ needs.build-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determinar status geral
        if [[ "${{ needs.code-analysis.result }}" == "success" && \
              "${{ needs.unit-tests.result }}" == "success" && \
              "${{ needs.firebase-security.result }}" == "success" && \
              "${{ needs.build-validation.result }}" == "success" ]]; then
          echo "## âœ… **RESULTADO**: Pipeline CI bem-sucedido!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ CÃ³digo pronto para merge/deploy" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ **RESULTADO**: Pipeline CI falhou" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ Revisar e corrigir problemas identificados" >> $GITHUB_STEP_SUMMARY
        fi
