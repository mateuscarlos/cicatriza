name: Performance Analysis

on:
  pull_request:
    branches: [ main ]
    paths: [ 'lib/**', 'test/**' ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1' # Executar toda segunda-feira Ã s 2h

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # =============================================================================
  # ANÃLISE DE PERFORMANCE
  # =============================================================================
  performance-analysis:
    name: ðŸ“Š Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: ðŸ” Analyze Package Dependencies
      run: |
        echo "## ðŸ“¦ AnÃ¡lise de DependÃªncias" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Analisar dependÃªncias
        flutter pub deps --style=compact > deps.txt
        
        # Contar dependÃªncias
        DIRECT_DEPS=$(grep -c "^[a-zA-Z]" pubspec.yaml || echo "0")
        TOTAL_DEPS=$(flutter pub deps --style=compact | grep -c "â”€" || echo "0")
        
        echo "ðŸ“Š **DependÃªncias Diretas**: $DIRECT_DEPS" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Total de DependÃªncias**: $TOTAL_DEPS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“± Build Size Analysis
      run: |
        echo "## ðŸ“± AnÃ¡lise de Tamanho do Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build APK para anÃ¡lise
        flutter build apk --debug --target-platform android-arm64
        
        # Analisar tamanho
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          echo "ðŸ“± **Tamanho APK Debug**: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se estÃ¡ dentro do limite recomendado (100MB)
          APK_SIZE_BYTES=$(du -b build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          if [ $APK_SIZE_BYTES -gt 104857600 ]; then
            echo "âš ï¸ **Aviso**: APK maior que 100MB" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status**: Tamanho dentro do limite recomendado" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: ðŸ§ª Performance Tests
      run: |
        echo "## ðŸ§ª Testes de Performance" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Executar testes de performance se existirem
        if [ -d "test/performance" ] && [ "$(ls -A test/performance)" ]; then
          echo "ðŸ§ª Executando testes de performance..."
          flutter test test/performance/ --reporter=json > performance_results.json || true
          
          if [ -f "performance_results.json" ]; then
            echo "âœ… Testes de performance executados" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ Nenhum teste de performance encontrado" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“Š Code Metrics
      run: |
        echo "## ðŸ“Š MÃ©tricas de CÃ³digo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Contar linhas de cÃ³digo
        DART_FILES=$(find lib -name "*.dart" | wc -l)
        DART_LINES=$(find lib -name "*.dart" -exec cat {} \; | wc -l)
        TEST_FILES=$(find test -name "*.dart" | wc -l 2>/dev/null || echo "0")
        
        echo "ðŸ“„ **Arquivos Dart**: $DART_FILES" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Linhas de CÃ³digo**: $DART_LINES" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ§ª **Arquivos de Teste**: $TEST_FILES" >> $GITHUB_STEP_SUMMARY
        
        # Calcular cobertura de testes (aproximada)
        if [ $TEST_FILES -gt 0 ] && [ $DART_FILES -gt 0 ]; then
          TEST_COVERAGE_RATIO=$(( $TEST_FILES * 100 / $DART_FILES ))
          echo "ðŸ“Š **ProporÃ§Ã£o Teste/CÃ³digo**: ${TEST_COVERAGE_RATIO}%" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ” Import Analysis
      run: |
        echo "## ðŸ” AnÃ¡lise de Imports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Verificar imports desnecessÃ¡rios
        UNUSED_IMPORTS=$(flutter analyze 2>&1 | grep -c "unused_import" || echo "0")
        UNUSED_FIELDS=$(flutter analyze 2>&1 | grep -c "unused_field" || echo "0")
        UNUSED_LOCALS=$(flutter analyze 2>&1 | grep -c "unused_local_variable" || echo "0")
        
        echo "ðŸ“¦ **Imports NÃ£o Utilizados**: $UNUSED_IMPORTS" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ·ï¸ **Campos NÃ£o Utilizados**: $UNUSED_FIELDS" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”¤ **VariÃ¡veis Locais NÃ£o Utilizadas**: $UNUSED_LOCALS" >> $GITHUB_STEP_SUMMARY
        
        TOTAL_UNUSED=$(($UNUSED_IMPORTS + $UNUSED_FIELDS + $UNUSED_LOCALS))
        if [ $TOTAL_UNUSED -eq 0 ]; then
          echo "âœ… **Status**: CÃ³digo limpo - nenhum elemento nÃ£o utilizado" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ§¹ **SugestÃ£o**: Limpar elementos nÃ£o utilizados" >> $GITHUB_STEP_SUMMARY
        fi

  # =============================================================================
  # BENCHMARK COMPARATIVO
  # =============================================================================
  benchmark-comparison:
    name: âš¡ Benchmark Comparison
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout Code (Current)
      uses: actions/checkout@v4

    - name: ðŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Install Dependencies
      run: flutter pub get

    - name: âš¡ Run Current Branch Benchmark
      run: |
        echo "âš¡ Executando benchmark da branch atual..."
        
        # Build atual
        time flutter build apk --debug > build_current.log 2>&1
        CURRENT_BUILD_TIME=$(grep real build_current.log | awk '{print $2}' || echo "N/A")
        
        echo "CURRENT_BUILD_TIME=$CURRENT_BUILD_TIME" >> $GITHUB_ENV

    - name: ðŸ“¥ Checkout Base Branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
        path: base-branch

    - name: âš¡ Run Base Branch Benchmark
      run: |
        echo "âš¡ Executando benchmark da branch base..."
        
        cd base-branch
        flutter pub get
        time flutter build apk --debug > ../build_base.log 2>&1 || true
        cd ..
        
        BASE_BUILD_TIME=$(grep real build_base.log | awk '{print $2}' || echo "N/A")
        echo "BASE_BUILD_TIME=$BASE_BUILD_TIME" >> $GITHUB_ENV

    - name: ðŸ“Š Benchmark Comparison Report
      run: |
        echo "## âš¡ ComparaÃ§Ã£o de Performance" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| MÃ©trica | Branch Base | Branch Atual | DiferenÃ§a |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------------|--------------|-----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tempo de Build | $BASE_BUILD_TIME | $CURRENT_BUILD_TIME | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Comparar tamanhos de APK se possÃ­vel
        BASE_APK="base-branch/build/app/outputs/flutter-apk/app-debug.apk"
        CURRENT_APK="build/app/outputs/flutter-apk/app-debug.apk"
        
        if [ -f "$BASE_APK" ] && [ -f "$CURRENT_APK" ]; then
          BASE_SIZE=$(du -h "$BASE_APK" | cut -f1)
          CURRENT_SIZE=$(du -h "$CURRENT_APK" | cut -f1)
          echo "| Tamanho APK | $BASE_SIZE | $CURRENT_SIZE | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Nota**: MÃ©tricas coletadas em ambiente CI - podem variar em builds locais" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # RECOMENDAÃ‡Ã•ES DE OTIMIZAÃ‡ÃƒO
  # =============================================================================
  optimization-recommendations:
    name: ðŸ’¡ Optimization Recommendations
    runs-on: ubuntu-latest
    needs: [performance-analysis]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ’¡ Generate Recommendations
      run: |
        echo "## ðŸ’¡ RecomendaÃ§Ãµes de OtimizaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Analisar pubspec.yaml para dependÃªncias pesadas
        if grep -q "firebase_" pubspec.yaml; then
          echo "ðŸ”¥ **Firebase**: Considere usar apenas os mÃ³dulos necessÃ¡rios do Firebase" >> $GITHUB_STEP_SUMMARY
        fi
        
        if grep -q "flutter_bloc" pubspec.yaml; then
          echo "ðŸ—ï¸ **BLoC**: Verifique se todos os BLoCs sÃ£o necessÃ¡rios e otimize o estado" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Verificar imagens grandes
        if [ -d "assets/images" ]; then
          LARGE_IMAGES=$(find assets/images -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) -size +500k | wc -l)
          if [ $LARGE_IMAGES -gt 0 ]; then
            echo "ðŸ–¼ï¸ **Imagens**: $LARGE_IMAGES imagens > 500KB encontradas - considere otimizaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Dicas Gerais de Performance:" >> $GITHUB_STEP_SUMMARY
        echo "- Use `const` constructors sempre que possÃ­vel" >> $GITHUB_STEP_SUMMARY
        echo "- Evite widgets desnecessÃ¡rios na Ã¡rvore" >> $GITHUB_STEP_SUMMARY
        echo "- Implemente lazy loading para listas grandes" >> $GITHUB_STEP_SUMMARY
        echo "- Use `RepaintBoundary` para widgets que mudam frequentemente" >> $GITHUB_STEP_SUMMARY
        echo "- Otimize imagens e use formatos apropriados" >> $GITHUB_STEP_SUMMARY