rules_version = '2';

/**
 * Firestore Security Rules — Cicatriza (PRODUÇÃO)
 * 
 * PRINCÍPIOS DE SEGURANÇA:
 * - Autenticação obrigatória para todas as operações
 * - Acesso baseado em proprietário (owner-based access)
 * - Validação rigorosa de dados com compliance LGPD
 * - Estrutura hierárquica: estomaterapeutas/{uid}/pacientes/{pid}/feridas/{wid}/avaliacoes/{aid}/media/{mid}
 * 
 * ESTRUTURA DE DADOS V5:
 * - Todos os documentos devem ter 'ownerId' igual ao uid do usuário autenticado
 * - Campos obrigatórios com versioning (versao >= 5)
 * - Dados clínicos comprimidos para otimização
 * - Consentimentos LGPD obrigatórios
 * - Strings sanitizadas (sem HTML/scripts)
 * - Timestamps controlados pelo servidor
 */

service cloud.firestore {
  match /databases/{db}/documents {

    // =============================================================================
    // HELPER FUNCTIONS - Funções de validação e segurança
    // =============================================================================
    
    // Verifica se usuário está autenticado
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }
    
    // Verifica se é o proprietário do documento
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Verifica se documento pertence ao usuário autenticado
    function isOwnerOfDocument() {
      return isAuthenticated() && 
             resource != null && 
             resource.data.ownerId == request.auth.uid;
    }
    
    // Verifica se novo documento será criado com ownerId correto
    function isCreatingOwnDocument() {
      return isAuthenticated() &&
             request.resource != null &&
             request.resource.data.ownerId == request.auth.uid;
    }
    
    // Validação de string segura (sem HTML/XSS)
    function isSafeString(value, maxLength) {
      return value is string &&
             value.size() > 0 &&
             value.size() <= maxLength &&
             !value.matches('.*<[^>]*>.*') &&
             !value.matches('.*javascript:.*') &&
             !value.matches('.*<script.*');
    }
    
    // Validação de string opcional
    function isOptionalSafeString(data, field, maxLength) {
      return !(field in data) || 
             isSafeString(data[field], maxLength);
    }
    
    // Validação de número dentro de range
    function isNumberInRange(value, min, max) {
      return (value is int || value is float) && 
             value >= min && 
             value <= max;
    }
    
    // Validação de campos obrigatórios do sistema
    function hasRequiredSystemFields(data) {
      return 'ownerId' in data &&
             'createdAt' in data &&
             'updatedAt' in data &&
             data.ownerId is string &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp;
    }

    // =============================================================================
    // VALIDATION FUNCTIONS - Validações específicas por entidade
    // =============================================================================
    
    // Validação de perfil de usuário
    function isValidUserProfile(data) {
      return hasRequiredSystemFields(data) &&
             isSafeString(data.email, 255) &&
             isOptionalSafeString(data, 'displayName', 200) &&
             isOptionalSafeString(data, 'photoURL', 500) &&
             ('lgpdConsent' in data) && data.lgpdConsent is bool;
    }
    
    // Validação de paciente com estrutura V5
    function isValidPatient(data) {
      return hasRequiredSystemFields(data) &&
             isSafeString(data.name, 200) &&
             isSafeString(data.nameLowercase, 200) &&
             isSafeString(data.pacienteId, 100) &&
             'consentimentos' in data &&
             isValidConsentimentos(data.consentimentos) &&
             'status' in data && data.status in ['ativo', 'inativo', 'transferido'] &&
             'versao' in data && data.versao is int && data.versao >= 5 &&
             ('birthDate' in data) && data.birthDate is timestamp &&
             isOptionalSafeString(data, 'notes', 2000) &&
             isOptionalSafeString(data, 'identificador', 50) &&
             isOptionalSafeString(data, 'nomeSocial', 200) &&
             isOptionalSafeString(data, 'genero', 50) &&
             isOptionalSafeString(data, 'cpfOuId', 20) &&
             isOptionalSafeString(data, 'email', 255) &&
             isOptionalSafeString(data, 'phone', 20) &&
             isValidClinicalData(data);
    }

    // Validação de consentimentos LGPD
    function isValidConsentimentos(consentimentos) {
      return consentimentos is map &&
             'coletaDados' in consentimentos &&
             consentimentos.coletaDados is bool &&
             consentimentos.coletaDados == true && // Obrigatório para uso do sistema
             'compartilhamentoInformacoes' in consentimentos &&
             consentimentos.compartilhamentoInformacoes is bool &&
             'comunicacaoEletronica' in consentimentos &&
             consentimentos.comunicacaoEletronica is bool &&
             'dataConsentimento' in consentimentos &&
             consentimentos.dataConsentimento is timestamp;
    }

    // Validação de dados clínicos comprimidos
    function isValidClinicalData(data) {
      // Se tem dados clínicos comprimidos, deve ter metadados
      return !('dadosClinicosComprimidos' in data) ||
             (('usaCompressao' in data) && data.usaCompressao is bool &&
              ('versaoEstrutura' in data) && data.versaoEstrutura is int &&
              data.versaoEstrutura >= 5 &&
              isSafeString(data.dadosClinicosComprimidos, 50000)); // Limite para dados JSON
    }
    
    // Validação de ferida com estrutura V5
    function isValidWound(data, patientId) {
      return hasRequiredSystemFields(data) &&
             'patientId' in data && data.patientId == patientId &&
             'feridaId' in data && isSafeString(data.feridaId, 100) &&
             'type' in data && data.type in [
               'ULCERA_PRESSAO', 'ULCERA_VENOSA', 'ULCERA_ARTERIAL', 'PE_DIABETICO',
               'QUEIMADURA', 'FERIDA_CIRURGICA', 'TRAUMATICA', 'OUTRAS'
             ] &&
             'localizacao' in data && isSafeString(data.localizacao, 200) &&
             'status' in data && data.status in [
               'ATIVA', 'EM_CICATRIZACAO', 'CICATRIZADA', 'INFECTADA', 'COMPLICADA'
             ] &&
             'criadoEm' in data && data.criadoEm is timestamp &&
             'atualizadoEm' in data && data.atualizadoEm is timestamp &&
             isOptionalSafeString(data, 'etiologia', 500) &&
             isOptionalSafeString(data, 'notes', 2000) &&
             ('contagemAvaliacoes' in data ? data.contagemAvaliacoes is int : true) &&
             ('archived' in data ? data.archived is bool : true);
    }
    
    // Validação de avaliação com estrutura V5
    function isValidAssessment(data, patientId, woundId) {
      return hasRequiredSystemFields(data) &&
             'patientId' in data && data.patientId == patientId &&
             'woundId' in data && data.woundId == woundId &&
             'assessmentId' in data && isSafeString(data.assessmentId, 100) &&
             'criadoEm' in data && data.criadoEm is timestamp &&
             'atualizadoEm' in data && data.atualizadoEm is timestamp &&
             'medidas' in data && isValidMedidas(data.medidas) &&
             'tecido' in data && isValidTecido(data.tecido) &&
             'exsudato' in data && isValidExsudato(data.exsudato) &&
             ('dor' in data ? isValidDor(data.dor) : true) &&
             isOptionalSafeString(data, 'observacoes', 2000) &&
             ('images' in data ? data.images is list : true);
    }

    // Validação de medidas da avaliação
    function isValidMedidas(medidas) {
      return medidas is map &&
             'comprimento' in medidas && medidas.comprimento is number && medidas.comprimento > 0 &&
             'largura' in medidas && medidas.largura is number && medidas.largura > 0 &&
             ('profundidade' in medidas ? medidas.profundidade is number && medidas.profundidade >= 0 : true) &&
             ('area' in medidas ? medidas.area is number && medidas.area >= 0 : true) &&
             ('volume' in medidas ? medidas.volume is number && medidas.volume >= 0 : true);
    }

    // Validação de tecido da ferida
    function isValidTecido(tecido) {
      return tecido is map &&
             ('granulacao' in tecido ? tecido.granulacao is int && tecido.granulacao >= 0 && tecido.granulacao <= 100 : true) &&
             ('fibrina' in tecido ? tecido.fibrina is int && tecido.fibrina >= 0 && tecido.fibrina <= 100 : true) &&
             ('necrose' in tecido ? tecido.necrose is int && tecido.necrose >= 0 && tecido.necrose <= 100 : true) &&
             ('epitelizacao' in tecido ? tecido.epitelizacao is int && tecido.epitelizacao >= 0 && tecido.epitelizacao <= 100 : true) &&
             ('outros' in tecido ? tecido.outros is int && tecido.outros >= 0 && tecido.outros <= 100 : true);
    }

    // Validação de exsudato da ferida
    function isValidExsudato(exsudato) {
      return exsudato is map &&
             ('tipo' in exsudato ? exsudato.tipo in ['SEROSO', 'SEROPURULENTO', 'PURULENTO', 'SANGUINOLENTO', 'OUTRO'] : true) &&
             ('quantidade' in exsudato ? exsudato.quantidade in ['AUSENTE', 'PEQUENA', 'MODERADA', 'GRANDE'] : true) &&
             ('aspecto' in exsudato ? exsudato.aspecto in ['CLARO', 'TURVO', 'ESPESSO', 'VISCOSO'] : true) &&
             ('odor' in exsudato ? exsudato.odor is bool : true);
    }

    // Validação de dor da ferida
    function isValidDor(dor) {
      return dor is map &&
             ('intensidade' in dor ? dor.intensidade is int && dor.intensidade >= 0 && dor.intensidade <= 10 : true) &&
             ('tipo' in dor ? dor.tipo in ['AUSENTE', 'LEVE', 'MODERADA', 'INTENSA', 'INSUPORTAVEL'] : true) &&
             ('localizacao' in dor ? isSafeString(dor.localizacao, 200) : true);
    }
    
    // Validação de mídia
    function isValidMedia(data, patientId, woundId, assessmentId) {
      return hasRequiredSystemFields(data) &&
             'patientId' in data && data.patientId == patientId &&
             'woundId' in data && data.woundId == woundId &&
             'assessmentId' in data && data.assessmentId == assessmentId &&
             'type' in data && data.type in ['image', 'video'] &&
             'storagePath' in data && isSafeString(data.storagePath, 500) &&
             'size' in data && data.size is int && data.size > 0 &&
             isOptionalSafeString(data, 'description', 500);
    }

    // =============================================================================
    // SECURITY RULES - Regras de acesso por coleção
    // =============================================================================
    
    // Estomaterapeutas - apenas o próprio usuário
    match /estomaterapeutas/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid) && isValidUserProfile(request.resource.data);
      allow update: if isOwner(uid) && 
                       isValidUserProfile(request.resource.data) &&
                       request.resource.data.ownerId == resource.data.ownerId; // Não pode alterar ownerId
      allow delete: if isOwner(uid);
      
      // Pacientes do estomaterapeuta
      match /pacientes/{patientId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid) && isValidPatient(request.resource.data);
        allow update: if isOwner(uid) && 
                         isValidPatient(request.resource.data) &&
                         request.resource.data.ownerId == resource.data.ownerId;
        allow delete: if isOwner(uid);
        
        // Feridas do paciente
        match /feridas/{woundId} {
          allow read: if isOwner(uid);
          allow create: if isOwner(uid) && isValidWound(request.resource.data, patientId);
          allow update: if isOwner(uid) && 
                           isValidWound(request.resource.data, patientId) &&
                           request.resource.data.ownerId == resource.data.ownerId;
          allow delete: if isOwner(uid);
          
          // Avaliações da ferida
          match /avaliacoes/{assessmentId} {
            allow read: if isOwner(uid);
            allow create: if isOwner(uid) && isValidAssessment(request.resource.data, patientId, woundId);
            allow update: if isOwner(uid) && 
                             isValidAssessment(request.resource.data, patientId, woundId) &&
                             request.resource.data.ownerId == resource.data.ownerId;
            allow delete: if isOwner(uid);
            
            // Mídia da avaliação
            match /midias/{mediaId} {
              allow read: if isOwner(uid);
              allow create: if isOwner(uid) && isValidMedia(request.resource.data, patientId, woundId, assessmentId);
              allow update: if isOwner(uid) && 
                               isValidMedia(request.resource.data, patientId, woundId, assessmentId) &&
                               request.resource.data.ownerId == resource.data.ownerId;
              allow delete: if isOwner(uid);
            }
          }
        }
      }
    }
    
    // =============================================================================
    // AUDIT & SUPPORT COLLECTIONS - Coleções auxiliares com segurança
    // =============================================================================
    
    // Log de auditoria - apenas criação e leitura própria
    match /audit/{auditId} {
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       'action' in request.resource.data &&
                       'timestamp' in request.resource.data &&
                       request.resource.data.timestamp is timestamp;
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      // Não permite update nem delete de audit logs
    }
    
    // Configurações do usuário
    match /userSettings/{uid} {
      allow read, write: if isOwner(uid);
    }
    
    // =============================================================================
    // DENY ALL OTHER ACCESS - Bloquear qualquer outro acesso
    // =============================================================================
    
    // Bloquear explicitamente qualquer outra operação não contemplada acima
    match /{document=**} {
      allow read, write: if false;
    }
  }
}